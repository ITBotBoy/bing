{"ast":null,"code":"const moment = require('moment');\n\nconst jsonfile = require('jsonfile');\n\nexport default (async (req, res) => {\n  let {\n    date = 0,\n    count = 0\n  } = req.query,\n      monthData;\n  if (!date) return res.json({\n    data: []\n  });\n  const {\n    imgArr\n  } = global; //  28\n\n  /*if(Number(date)){\r\n      console.log(date)\r\n      date=String(date).slice(0,6)\r\n      monthData=imgArr.filter(i=>String(i.date).includes(date))\r\n      //今天距离月初的天数\r\n      // count=new Date(date.slice(4), date.slice(2), 0).getDate()\r\n  }else {\r\n      const now = moment().format('YYYYMM');\r\n      monthData=imgArr.filter(i=>String(i.date).includes(now))\r\n      if(monthData.length<28){\r\n          const last=moment().subtract(1, 'month').format('YYYYMM')\r\n          const lastMonthData=imgArr.filter(i=>String(i.date).includes(last))\r\n          console.log(imgArr.length,'lastMonthData')\r\n          monthData=monthData.concat(lastMonthData)\r\n      }\r\n  }*/\n  //读取后一个月的数据保证始终超过10条\n\n  const currentDate = moment(date || new Date());\n  const currentFileName = currentDate.format('YYYYMM');\n  const laseFileName = currentDate.subtract(1, 'months').format('YYYYMM');\n  console.log(currentFileName, laseFileName);\n  const {\n    imgs: currentMonthData\n  } = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`).catch(() => ({\n    imgs: []\n  }));\n  const {\n    imgs: lastMonthData\n  } = await jsonfile.readFileSync(`bing_data/${laseFileName}.json`).catch(() => ({\n    imgs: []\n  })).catch(() => ({}));\n  let startIndex = imgArr.findIndex(({\n    date: d\n  }) => date === `${d}`);\n  startIndex < 0 && (startIndex = imgArr.length - 1); // console.log(currentMonthData[0]?.date,lastMonthData[0]?.date)\n\n  console.log(currentMonthData, lastMonthData, '[0]');\n  res.json({\n    data: [...currentMonthData, ...lastMonthData].slice(Math.max(0, startIndex - (count - 1)), startIndex + 1).reverse()\n  });\n});","map":{"version":3,"sources":["E:/Future/bing/pages/api/list.js"],"names":["moment","require","jsonfile","req","res","date","count","query","monthData","json","data","imgArr","global","currentDate","Date","currentFileName","format","laseFileName","subtract","console","log","imgs","currentMonthData","readFileSync","catch","lastMonthData","startIndex","findIndex","d","length","slice","Math","max","reverse"],"mappings":"AAAA,MAAMA,MAAM,GAAGC,OAAO,CAAC,QAAD,CAAtB;;AACA,MAAMC,QAAQ,GAAGD,OAAO,CAAC,UAAD,CAAxB;;AACA,gBAAe,OAAOE,GAAP,EAAYC,GAAZ,KAAoB;AACjC,MAAI;AAAEC,IAAAA,IAAI,GAAG,CAAT;AAAWC,IAAAA,KAAK,GAAG;AAAnB,MAAyBH,GAAG,CAACI,KAAjC;AAAA,MAAuCC,SAAvC;AACA,MAAG,CAACH,IAAJ,EAAU,OAAOD,GAAG,CAACK,IAAJ,CAAS;AAACC,IAAAA,IAAI,EAAC;AAAN,GAAT,CAAP;AACV,QAAM;AAAEC,IAAAA;AAAF,MAAaC,MAAnB,CAHiC,CAIjC;;AACA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI;;AACA,QAAMC,WAAW,GAAGb,MAAM,CAACK,IAAI,IAAI,IAAIS,IAAJ,EAAT,CAA1B;AACA,QAAMC,eAAe,GAAGF,WAAW,CAACG,MAAZ,CAAmB,QAAnB,CAAxB;AACA,QAAMC,YAAY,GAAGJ,WAAW,CAACK,QAAZ,CAAqB,CAArB,EAAuB,QAAvB,EAAiCF,MAAjC,CAAwC,QAAxC,CAArB;AACAG,EAAAA,OAAO,CAACC,GAAR,CAAYL,eAAZ,EAA4BE,YAA5B;AACA,QAAM;AAACI,IAAAA,IAAI,EAACC;AAAN,MAA0B,MAAMpB,QAAQ,CAACqB,YAAT,CAAuB,aAAYR,eAAgB,OAAnD,EAA2DS,KAA3D,CAAiE,OAAO;AAACH,IAAAA,IAAI,EAAC;AAAN,GAAP,CAAjE,CAAtC;AACA,QAAM;AAACA,IAAAA,IAAI,EAACI;AAAN,MAAuB,MAAMvB,QAAQ,CAACqB,YAAT,CAAuB,aAAYN,YAAa,OAAhD,EAAwDO,KAAxD,CAA8D,OAAO;AAACH,IAAAA,IAAI,EAAC;AAAN,GAAP,CAA9D,EAC9BG,KAD8B,CACxB,OAAO,EAAP,CADwB,CAAnC;AAEA,MAAIE,UAAU,GAAGf,MAAM,CAACgB,SAAP,CAAiB,CAAC;AAAEtB,IAAAA,IAAI,EAAEuB;AAAR,GAAD,KAAiBvB,IAAI,KAAM,GAAEuB,CAAE,EAAhD,CAAjB;AACCF,EAAAA,UAAU,GAAG,CAAd,KAAqBA,UAAU,GAAGf,MAAM,CAACkB,MAAP,GAAc,CAAhD,EA9B+B,CA+BjC;;AACAV,EAAAA,OAAO,CAACC,GAAR,CAAYE,gBAAZ,EAA6BG,aAA7B,EAA2C,KAA3C;AACArB,EAAAA,GAAG,CAACK,IAAJ,CAAS;AACPC,IAAAA,IAAI,EAAE,CAAC,GAAGY,gBAAJ,EAAqB,GAAGG,aAAxB,EAAuCK,KAAvC,CAA6CC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYN,UAAU,IAAIpB,KAAK,GAAC,CAAV,CAAtB,CAA7C,EAAkFoB,UAAU,GAAG,CAA/F,EAAkGO,OAAlG;AADC,GAAT;AAGD,CApCD","sourcesContent":["const moment = require('moment');\r\nconst jsonfile = require('jsonfile')\r\nexport default async (req, res) => {\r\n  let { date = 0,count = 0 } = req.query,monthData;\r\n  if(!date) return res.json({data:[]})\r\n  const { imgArr } = global;\r\n  //  28\r\n  /*if(Number(date)){\r\n      console.log(date)\r\n      date=String(date).slice(0,6)\r\n      monthData=imgArr.filter(i=>String(i.date).includes(date))\r\n      //今天距离月初的天数\r\n      // count=new Date(date.slice(4), date.slice(2), 0).getDate()\r\n  }else {\r\n      const now = moment().format('YYYYMM');\r\n      monthData=imgArr.filter(i=>String(i.date).includes(now))\r\n      if(monthData.length<28){\r\n          const last=moment().subtract(1, 'month').format('YYYYMM')\r\n          const lastMonthData=imgArr.filter(i=>String(i.date).includes(last))\r\n          console.log(imgArr.length,'lastMonthData')\r\n          monthData=monthData.concat(lastMonthData)\r\n      }\r\n  }*/\r\n    //读取后一个月的数据保证始终超过10条\r\n    const currentDate = moment(date || new Date())\r\n    const currentFileName = currentDate.format('YYYYMM')\r\n    const laseFileName = currentDate.subtract(1,'months').format('YYYYMM');\r\n    console.log(currentFileName,laseFileName)\r\n    const {imgs:currentMonthData} = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`).catch(() => ({imgs:[]}))\r\n    const {imgs:lastMonthData} = await jsonfile.readFileSync(`bing_data/${laseFileName}.json`).catch(() => ({imgs:[]}))\r\n        .catch(() => ({}))\r\n    let startIndex = imgArr.findIndex(({ date: d }) => date === `${d}`);\r\n    (startIndex < 0) && (startIndex = imgArr.length-1);\r\n  // console.log(currentMonthData[0]?.date,lastMonthData[0]?.date)\r\n  console.log(currentMonthData,lastMonthData,'[0]')\r\n  res.json({\r\n    data: [...currentMonthData,...lastMonthData].slice(Math.max(0, startIndex - (count-1)), startIndex + 1).reverse()\r\n  })\r\n}\r\n"]},"metadata":{},"sourceType":"module"}