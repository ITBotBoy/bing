{"ast":null,"code":"import { useRouter } from \"next/router\";\nimport { useState, useEffect, useRef } from 'react';\nimport { message, Spin } from \"antd\";\nimport moment from \"moment\";\nimport '../styles/[date].scss';\nimport DownDialog from \"../components/downDialog\";\nimport Error from 'next/error';\nimport maxBy from 'lodash/maxBy';\nimport minBy from 'lodash/minBy';\nimport axios from \"axios\";\nimport throttle from \"lodash/throttle\";\nimport Head from \"../components/Head\"; // import axios from \"axios\";\n// import throttle from \"lodash/throttle\";\n\nexport async function getServerSideProps(context) {\n  const {\n    imgArr,\n    tomorrow\n  } = global;\n  const {\n    date\n  } = context.query;\n  let key = date;\n  const minDate = minBy(imgArr, 'date');\n  const maxDate = maxBy(imgArr, 'date');\n\n  if (date === 'random') {\n    const index = Math.floor(Math.random() * imgArr.length);\n    key = imgArr[index].date;\n  }\n\n  return {\n    props: {\n      minDate,\n      maxDate,\n      img: imgArr[key] || {},\n      timeout: tomorrow - moment() + 5000,\n      nextKey: tomorrow.format('YYYYMMDD')\n    }\n  };\n}\nexport default function date({\n  minDate,\n  maxDate,\n  img = {},\n  timeout,\n  nextKey\n}) {\n  const router = useRouter();\n  const [loading, updateLoading] = useState(true);\n  const [showBottom, updateShowBottom] = useState(true);\n  const [now, updateNow] = useState(new Date().valueOf());\n  const [downDialogVisible, setDownDialogVisible] = useState(false);\n  const [isMobile, setIsMobile] = useState(false);\n  const [likeList, setLikeList] = useState([]);\n\n  const checkMode = () => {\n    if (window.innerWidth < 1024 || window.innerWidth < window.innerHeight) {\n      setIsMobile(true);\n    } else {\n      setIsMobile(false);\n    }\n  }; // likeFun\n\n\n  const likeFun = data => {\n    let localLikeList = window.localStorage.getItem('localLikeList');\n\n    if (!likeList.length && localLikeList) {\n      setLikeList(JSON.parse(localLikeList));\n    }\n\n    if (data) {\n      localLikeList = localLikeList ? JSON.parse(localLikeList) : [];\n\n      if (!localLikeList.includes(data)) {\n        axios(`/api/sort?date=${data}&k=likeCount`).then(res => {\n          if (res.data.likeCount) {\n            localLikeList.push(data);\n            setLikeList(localLikeList);\n            window.localStorage.setItem('localLikeList', JSON.stringify(localLikeList));\n          }\n        });\n      }\n    }\n  };\n\n  const throttleLikeFun = throttle(data => likeFun(data), 1500);\n\n  if (false && window) {\n    likeFun();\n  }\n\n  const downloadFun = data => {\n    if (data) {\n      axios(`/api/sort?date=${data}&k=downloadCount`);\n    }\n  }; // did mount\n\n\n  const loadingImg = useRef();\n  useEffect(() => {\n    // 图片加载完成就取消 loading\n    if (loadingImg.current && loadingImg.current.complete) {\n      updateLoading(false);\n    }\n\n    checkMode();\n\n    window.onkeyup = ({\n      keyCode\n    }) => {\n      switch (keyCode) {\n        case 32:\n          return window.location = `/random`;\n\n        /*const date = Math.floor(Math.random() * (maxDate-minDate))+minDate;\n        changePosition(date);*/\n\n        case 37:\n        case 39:\n          changePosition({\n            37: 'prev',\n            39: 'next'\n          }[keyCode]);\n          break;\n\n        default:\n          break;\n      }\n    };\n\n    window.onresize = checkMode;\n    setTimeout(() => {\n      !img.next && (img.next = nextKey);\n    }, timeout);\n  }, []); // 前后切换\n\n  const changePosition = key => {\n    if (!img[key]) {\n      return message.warning({\n        prev: '没有更早的辣！',\n        next: '已经是最新的辣！'\n      }[key]);\n    }\n\n    updateLoading(true);\n    window.location = `/${img[key]}`;\n  }; // 移动鼠标，显示底下区域\n\n\n  const onMouseMove = () => {\n    updateShowBottom(true);\n    updateNow(new Date().valueOf());\n  };\n\n  useEffect(() => {\n    const tick = setTimeout(() => updateShowBottom(false), 3500);\n    return () => {\n      clearTimeout(tick);\n    };\n  }, [now]);\n  const imgDate = moment(String(img.date), 'YYYYMMDD');\n  return img.date ? <Spin spinning={loading} size=\"large\">\n            <Head></Head>\n            <div className={`detail-page ${isMobile && 'mobile-mode'}`} onMouseMove={onMouseMove}>\n                <img className=\"loading-img\" ref={loadingImg} src={`//cn.bing.com${img.urlbase}_${isMobile ? '768x1280' : '1920x1080'}.jpg`} onLoad={() => updateLoading(false)} />\n                <div className=\"img-content-box\" style={{\n        backgroundImage: `url(//cn.bing.com${img.urlbase}_${isMobile ? '768x1280' : '1920x1080'}.jpg)`\n      }}>\n                    {[{\n          key: 'prev',\n          arrow: 'left'\n        }, {\n          key: 'next',\n          arrow: 'right'\n        }].map(({\n          key,\n          arrow\n        }) => img[key] ? <div key={`page-${arrow}`} className={`page-icon icon-${arrow} ${(showBottom || isMobile) && 'actived'}`} onClick={() => changePosition(key)}>\n                                        <i className={`iconfont icon-arrow-${arrow}`} />\n                                    </div> : '')}\n\n                    <div className=\"img-info\">\n                        <div className=\"img-date\">\n                            <div className=\"img-date-year\">{imgDate.format('YY')}</div>\n                            <div className=\"img-date-md\">\n                                <div>{imgDate.format('MM')}</div>\n                                <div>{imgDate.format('DD')}</div>\n                            </div>\n                        </div>\n                        <div className=\"img-cp\">\n                            <div className=\"img-cp-txt\">{img.cp}</div>\n                        </div>\n                    </div>\n\n                    <div className={`bottom-info ${showBottom && 'actived'}`}>\n                        <div className=\"icon-list\">\n                            <a href=\"/\" className=\"iconfont icon-bing\" />\n                            {false && <div className={(likeList.includes(img.date) ? 'icon-like-fill' : 'icon-xihuan') + ' iconfont'} onClick={() => throttleLikeFun(img.date)} />}\n                            <div className=\"iconfont icon-download\" onClick={() => setDownDialogVisible(true)} />\n                            <a href=\"/random\" className=\"iconfont icon-touzi\" />\n                            <a href=\"/about\" className=\"iconfont icon-about\" />\n                            <a href=\"https://github.com/renserve/bing\" rel=\"external nofollow noopener noreferrer\" target=\"_blank\" className=\"iconfont icon-github\" />\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <DownDialog downloadFun={downloadFun} isMobile={isMobile} visible={downDialogVisible} onHide={() => setDownDialogVisible(false)} imgInfo={img} />\n        </Spin> : <Error statusCode={404} />;\n}","map":{"version":3,"sources":["F:/bing/Bing/pages/[date].js"],"names":["useRouter","useState","useEffect","useRef","message","Spin","moment","DownDialog","Error","maxBy","minBy","axios","throttle","Head","getServerSideProps","context","imgArr","tomorrow","global","date","query","key","minDate","maxDate","index","Math","floor","random","length","props","img","timeout","nextKey","format","router","loading","updateLoading","showBottom","updateShowBottom","now","updateNow","Date","valueOf","downDialogVisible","setDownDialogVisible","isMobile","setIsMobile","likeList","setLikeList","checkMode","window","innerWidth","innerHeight","likeFun","data","localLikeList","localStorage","getItem","JSON","parse","includes","then","res","likeCount","push","setItem","stringify","throttleLikeFun","downloadFun","loadingImg","current","complete","onkeyup","keyCode","location","changePosition","onresize","setTimeout","next","warning","prev","onMouseMove","tick","clearTimeout","imgDate","String","urlbase","backgroundImage","arrow","map","cp"],"mappings":"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","sourcesContent":["import {useRouter} from \"next/router\";\nimport {useState, useEffect, useRef} from 'react';\nimport {message, Spin} from \"antd\";\nimport moment from \"moment\";\nimport '../styles/[date].scss';\nimport DownDialog from \"../components/downDialog\";\nimport Error from 'next/error';\nimport maxBy from 'lodash/maxBy'\nimport minBy from 'lodash/minBy'\nimport axios from \"axios\";\nimport throttle from \"lodash/throttle\";\nimport Head from \"../components/Head\";\n// import axios from \"axios\";\n// import throttle from \"lodash/throttle\";\nexport async function getServerSideProps(context) {\n    const {imgArr, tomorrow} = global;\n    const {date} = context.query;\n    let key = date;\n    const minDate=minBy(imgArr,'date')\n    const maxDate=maxBy(imgArr,'date')\n    if (date === 'random') {\n        const index = Math.floor(Math.random() * imgArr.length);\n        key = imgArr[index].date;\n    }\n    return {\n        props: {\n            minDate,\n            maxDate,\n            img: imgArr[key] || {},\n            timeout: tomorrow - moment() + 5000,\n            nextKey: tomorrow.format('YYYYMMDD')\n        }\n    }\n}\n\nexport default function date({minDate,maxDate,img = {}, timeout, nextKey}) {\n    const router = useRouter();\n\n    const [loading, updateLoading] = useState(true);\n    const [showBottom, updateShowBottom] = useState(true);\n    const [now, updateNow] = useState(new Date().valueOf());\n    const [downDialogVisible, setDownDialogVisible] = useState(false);\n    const [isMobile, setIsMobile] = useState(false);\n    const [likeList, setLikeList] = useState([]);\n\n    const checkMode = () => {\n        if (window.innerWidth < 1024 || window.innerWidth < window.innerHeight) {\n            setIsMobile(true);\n        } else {\n            setIsMobile(false);\n        }\n    }\n    // likeFun\n    const likeFun = (data) => {\n        let localLikeList=window.localStorage.getItem('localLikeList')\n        if(!likeList.length && localLikeList){\n            setLikeList(JSON.parse(localLikeList))\n        }\n        if(data){\n            localLikeList=localLikeList?JSON.parse(localLikeList):[]\n            if(!localLikeList.includes(data)){\n                axios(`/api/sort?date=${data}&k=likeCount`)\n                    .then(res => {\n                        if(res.data.likeCount){\n                            localLikeList.push(data)\n                            setLikeList(localLikeList)\n                            window.localStorage.setItem('localLikeList',JSON.stringify(localLikeList))\n                        }\n                    })\n            }\n        }\n    }\n    const throttleLikeFun=throttle((data)=>likeFun(data),1500)\n    if(typeof window !== 'undefined' && window){\n        likeFun()\n    }\n    const downloadFun = (data) => {\n        if(data){\n            axios(`/api/sort?date=${data}&k=downloadCount`)\n        }\n    }\n    // did mount\n    const loadingImg = useRef();\n    useEffect(() => {\n        // 图片加载完成就取消 loading\n        if (loadingImg.current && loadingImg.current.complete) {\n            updateLoading(false);\n        }\n        checkMode();\n        window.onkeyup = ({keyCode}) => {\n            switch (keyCode) {\n                case 32:\n                    return window.location = `/random`;\n                    /*const date = Math.floor(Math.random() * (maxDate-minDate))+minDate;\n                    changePosition(date);*/\n                case 37:\n                case 39:\n                    changePosition({37: 'prev', 39: 'next'}[keyCode]);\n                    break;\n                default:\n                    break;\n            }\n        }\n        window.onresize = checkMode;\n\n        setTimeout(() => {\n            !img.next && (img.next = nextKey);\n        }, timeout)\n    }, []);\n    // 前后切换\n    const changePosition = (key) => {\n        if (!img[key]) {\n            return message.warning({\n                prev: '没有更早的辣！',\n                next: '已经是最新的辣！',\n            }[key])\n        }\n        updateLoading(true);\n        window.location = `/${img[key]}`;\n    }\n\n    // 移动鼠标，显示底下区域\n    const onMouseMove = () => {\n        updateShowBottom(true);\n        updateNow(new Date().valueOf())\n    }\n    useEffect(\n        () => {\n            const tick = setTimeout(() => updateShowBottom(false), 3500);\n            return () => {\n                clearTimeout(tick);\n            };\n        },\n        [now]\n    );\n\n    const imgDate = moment(String(img.date), 'YYYYMMDD');\n\n    return img.date ? (\n        <Spin spinning={loading} size=\"large\">\n            <Head></Head>\n            <div className={`detail-page ${isMobile && 'mobile-mode'}`} onMouseMove={onMouseMove}>\n                <img className=\"loading-img\" ref={loadingImg}\n                     src={`//cn.bing.com${img.urlbase}_${isMobile ? '768x1280' : '1920x1080'}.jpg`}\n                     onLoad={() => updateLoading(false)}/>\n                <div\n                    className=\"img-content-box\"\n                    style={{backgroundImage: `url(//cn.bing.com${img.urlbase}_${isMobile ? '768x1280' : '1920x1080'}.jpg)`}}\n                >\n                    {\n                        [{key: 'prev', arrow: 'left'}, {key: 'next', arrow: 'right'}]\n                            .map(({key, arrow}) => (\n                                img[key] ? (\n                                    <div key={`page-${arrow}`}\n                                         className={`page-icon icon-${arrow} ${(showBottom || isMobile) && 'actived'}`}\n                                         onClick={() => changePosition(key)}>\n                                        <i className={`iconfont icon-arrow-${arrow}`}/>\n                                    </div>\n                                ) : ''\n                            ))\n                    }\n\n                    <div className=\"img-info\">\n                        <div className=\"img-date\">\n                            <div className=\"img-date-year\">{imgDate.format('YY')}</div>\n                            <div className=\"img-date-md\">\n                                <div>{imgDate.format('MM')}</div>\n                                <div>{imgDate.format('DD')}</div>\n                            </div>\n                        </div>\n                        <div className=\"img-cp\">\n                            <div className=\"img-cp-txt\">{img.cp}</div>\n                        </div>\n                    </div>\n\n                    <div className={`bottom-info ${showBottom && 'actived'}`}>\n                        <div className=\"icon-list\">\n                            <a href=\"/\" className=\"iconfont icon-bing\"/>\n                            {typeof window!=='undefined' && <div className={(likeList.includes(img.date)?'icon-like-fill':'icon-xihuan')+' iconfont'} onClick={() => throttleLikeFun(img.date)}/>}\n                            <div className=\"iconfont icon-download\" onClick={() => setDownDialogVisible(true)}/>\n                            <a href=\"/random\" className=\"iconfont icon-touzi\"/>\n                            <a href=\"/about\" className=\"iconfont icon-about\"/>\n                            <a href=\"https://github.com/renserve/bing\" rel=\"external nofollow noopener noreferrer\"\n                               target=\"_blank\" className=\"iconfont icon-github\"/>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <DownDialog downloadFun={downloadFun} isMobile={isMobile} visible={downDialogVisible} onHide={() => setDownDialogVisible(false)}\n                        imgInfo={img}/>\n        </Spin>\n    ) : <Error statusCode={404}/>\n}\n"]},"metadata":{},"sourceType":"module"}