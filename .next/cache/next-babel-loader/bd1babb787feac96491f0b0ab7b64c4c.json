{"ast":null,"code":"const moment = require('moment');\n\nconst jsonfile = require('jsonfile');\n\nconst sortBy = require('lodash/sortBy');\n\nexport default (async (req, res) => {\n  let {\n    date = 0,\n    count = 0\n  } = req.query,\n      monthData;\n  if (!date) return res.json({\n    data: []\n  });\n  const {\n    imgArr\n  } = global; //  28\n\n  /*if(Number(date)){\r\n      console.log(date)\r\n      date=String(date).slice(0,6)\r\n      monthData=imgArr.filter(i=>String(i.date).includes(date))\r\n      //今天距离月初的天数\r\n      // count=new Date(date.slice(4), date.slice(2), 0).getDate()\r\n  }else {\r\n      const now = moment().format('YYYYMM');\r\n      monthData=imgArr.filter(i=>String(i.date).includes(now))\r\n      if(monthData.length<28){\r\n          const last=moment().subtract(1, 'month').format('YYYYMM')\r\n          const lastMonthData=imgArr.filter(i=>String(i.date).includes(last))\r\n          console.log(imgArr.length,'lastMonthData')\r\n          monthData=monthData.concat(lastMonthData)\r\n      }\r\n  }*/\n  //读取后一个月的数据保证始终超过10条\n\n  let currentMonthData = [],\n      lastMonthData = []; // const currentDate = moment(date || new Date().getTime()) // 引用报错\n\n  const currentFileName = moment(/\\d{6,}/.test(date) ? date : new Date().getTime()).format('YYYYMM');\n  const lastFileName = moment(/\\d{6,}/.test(date) ? date : new Date().getTime()).subtract(1, 'months').format('YYYYMM');\n\n  try {\n    console.log(currentFileName, lastFileName);\n    const {\n      imgs: currentMonthImgs\n    } = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`); // console.log(currentFileName,'currentMonthImgs')\n    // const {imgs:currentMonthImgs} = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`)\n\n    const {\n      imgs: lastMonthImgs\n    } = await jsonfile.readFileSync(`bing_data/${lastFileName}.json`);\n    console.log(lastMonthImgs);\n    currentMonthData = currentMonthImgs;\n    lastMonthData = lastMonthImgs;\n  } catch (e) {}\n\n  const data = [...currentMonthData, ...lastMonthData];\n  console.log(data.map(i => i.date)); // console.log(currentMonthData.length,lastMonthData.length)\n\n  let startIndex = data.findIndex(({\n    date: d\n  }) => date === `${d}`);\n  startIndex < 0 && (startIndex = data.length - 1); // console.log(currentMonthData[0]?.date,lastMonthData[0]?.date)\n  // console.log(currentMonthData,lastMonthData,'[0]')\n\n  console.log(data.length, Math.max(0, startIndex - (count - 1)), 'data');\n  res.json({\n    data: sortBy(data, 'date').slice(Math.max(0, startIndex - (count - 1)), startIndex + 1)\n  });\n});","map":{"version":3,"sources":["E:/Future/bing/pages/api/list.js"],"names":["moment","require","jsonfile","sortBy","req","res","date","count","query","monthData","json","data","imgArr","global","currentMonthData","lastMonthData","currentFileName","test","Date","getTime","format","lastFileName","subtract","console","log","imgs","currentMonthImgs","readFileSync","lastMonthImgs","e","map","i","startIndex","findIndex","d","length","Math","max","slice"],"mappings":"AAAA,MAAMA,MAAM,GAAGC,OAAO,CAAC,QAAD,CAAtB;;AACA,MAAMC,QAAQ,GAAGD,OAAO,CAAC,UAAD,CAAxB;;AACA,MAAME,MAAM,GAACF,OAAO,CAAC,eAAD,CAApB;;AACA,gBAAe,OAAOG,GAAP,EAAYC,GAAZ,KAAoB;AACjC,MAAI;AAAEC,IAAAA,IAAI,GAAG,CAAT;AAAWC,IAAAA,KAAK,GAAG;AAAnB,MAAyBH,GAAG,CAACI,KAAjC;AAAA,MAAuCC,SAAvC;AACA,MAAG,CAACH,IAAJ,EAAU,OAAOD,GAAG,CAACK,IAAJ,CAAS;AAACC,IAAAA,IAAI,EAAC;AAAN,GAAT,CAAP;AACV,QAAM;AAAEC,IAAAA;AAAF,MAAaC,MAAnB,CAHiC,CAIjC;;AACA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACI;;AACA,MAAIC,gBAAgB,GAAC,EAArB;AAAA,MAAwBC,aAAa,GAAC,EAAtC,CAtB+B,CAuB/B;;AACA,QAAMC,eAAe,GAAGhB,MAAM,CAAC,SAASiB,IAAT,CAAcX,IAAd,IAAqBA,IAArB,GAA0B,IAAIY,IAAJ,GAAWC,OAAX,EAA3B,CAAN,CAAuDC,MAAvD,CAA8D,QAA9D,CAAxB;AACA,QAAMC,YAAY,GAAGrB,MAAM,CAAC,SAASiB,IAAT,CAAcX,IAAd,IAAqBA,IAArB,GAA0B,IAAIY,IAAJ,GAAWC,OAAX,EAA3B,CAAN,CAAuDG,QAAvD,CAAgE,CAAhE,EAAkE,QAAlE,EAA4EF,MAA5E,CAAmF,QAAnF,CAArB;;AACA,MAAI;AACAG,IAAAA,OAAO,CAACC,GAAR,CAAYR,eAAZ,EAA4BK,YAA5B;AACA,UAAM;AAACI,MAAAA,IAAI,EAACC;AAAN,QAA0B,MAAMxB,QAAQ,CAACyB,YAAT,CAAuB,aAAYX,eAAgB,OAAnD,CAAtC,CAFA,CAGA;AACA;;AACA,UAAM;AAACS,MAAAA,IAAI,EAACG;AAAN,QAAuB,MAAM1B,QAAQ,CAACyB,YAAT,CAAuB,aAAYN,YAAa,OAAhD,CAAnC;AACAE,IAAAA,OAAO,CAACC,GAAR,CAAYI,aAAZ;AACAd,IAAAA,gBAAgB,GAAGY,gBAAnB;AACAX,IAAAA,aAAa,GAAGa,aAAhB;AACH,GATD,CASC,OAAOC,CAAP,EAAU,CAEV;;AACD,QAAMlB,IAAI,GAAC,CAAC,GAAGG,gBAAJ,EAAqB,GAAGC,aAAxB,CAAX;AACAQ,EAAAA,OAAO,CAACC,GAAR,CAAYb,IAAI,CAACmB,GAAL,CAASC,CAAC,IAAEA,CAAC,CAACzB,IAAd,CAAZ,EAvC+B,CAwC/B;;AACA,MAAI0B,UAAU,GAAGrB,IAAI,CAACsB,SAAL,CAAe,CAAC;AAAE3B,IAAAA,IAAI,EAAE4B;AAAR,GAAD,KAAiB5B,IAAI,KAAM,GAAE4B,CAAE,EAA9C,CAAjB;AACCF,EAAAA,UAAU,GAAG,CAAd,KAAqBA,UAAU,GAAGrB,IAAI,CAACwB,MAAL,GAAY,CAA9C,EA1C+B,CA2CjC;AACA;;AACEZ,EAAAA,OAAO,CAACC,GAAR,CAAYb,IAAI,CAACwB,MAAjB,EAAwBC,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYL,UAAU,IAAIzB,KAAK,GAAC,CAAV,CAAtB,CAAxB,EAA4D,MAA5D;AACFF,EAAAA,GAAG,CAACK,IAAJ,CAAS;AACPC,IAAAA,IAAI,EAAER,MAAM,CAACQ,IAAD,EAAM,MAAN,CAAN,CAAoB2B,KAApB,CAA0BF,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYL,UAAU,IAAIzB,KAAK,GAAC,CAAV,CAAtB,CAA1B,EAA+DyB,UAAU,GAAG,CAA5E;AADC,GAAT;AAGD,CAjDD","sourcesContent":["const moment = require('moment');\r\nconst jsonfile = require('jsonfile')\r\nconst sortBy=require('lodash/sortBy')\r\nexport default async (req, res) => {\r\n  let { date = 0,count = 0 } = req.query,monthData;\r\n  if(!date) return res.json({data:[]})\r\n  const { imgArr } = global;\r\n  //  28\r\n  /*if(Number(date)){\r\n      console.log(date)\r\n      date=String(date).slice(0,6)\r\n      monthData=imgArr.filter(i=>String(i.date).includes(date))\r\n      //今天距离月初的天数\r\n      // count=new Date(date.slice(4), date.slice(2), 0).getDate()\r\n  }else {\r\n      const now = moment().format('YYYYMM');\r\n      monthData=imgArr.filter(i=>String(i.date).includes(now))\r\n      if(monthData.length<28){\r\n          const last=moment().subtract(1, 'month').format('YYYYMM')\r\n          const lastMonthData=imgArr.filter(i=>String(i.date).includes(last))\r\n          console.log(imgArr.length,'lastMonthData')\r\n          monthData=monthData.concat(lastMonthData)\r\n      }\r\n  }*/\r\n    //读取后一个月的数据保证始终超过10条\r\n    let currentMonthData=[],lastMonthData=[];\r\n    // const currentDate = moment(date || new Date().getTime()) // 引用报错\r\n    const currentFileName = moment(/\\d{6,}/.test(date)? date:new Date().getTime()).format('YYYYMM')\r\n    const lastFileName = moment(/\\d{6,}/.test(date)? date:new Date().getTime()).subtract(1,'months').format('YYYYMM');\r\n    try {\r\n        console.log(currentFileName,lastFileName)\r\n        const {imgs:currentMonthImgs} = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`)\r\n        // console.log(currentFileName,'currentMonthImgs')\r\n        // const {imgs:currentMonthImgs} = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`)\r\n        const {imgs:lastMonthImgs} = await jsonfile.readFileSync(`bing_data/${lastFileName}.json`)\r\n        console.log(lastMonthImgs)\r\n        currentMonthData = currentMonthImgs\r\n        lastMonthData = lastMonthImgs\r\n    }catch (e) {\r\n\r\n    }\r\n    const data=[...currentMonthData,...lastMonthData]\r\n    console.log(data.map(i=>i.date))\r\n    // console.log(currentMonthData.length,lastMonthData.length)\r\n    let startIndex = data.findIndex(({ date: d }) => date === `${d}`);\r\n    (startIndex < 0) && (startIndex = data.length-1);\r\n  // console.log(currentMonthData[0]?.date,lastMonthData[0]?.date)\r\n  // console.log(currentMonthData,lastMonthData,'[0]')\r\n    console.log(data.length,Math.max(0, startIndex - (count-1)),'data')\r\n  res.json({\r\n    data: sortBy(data,'date').slice(Math.max(0, startIndex - (count-1)), startIndex + 1)\r\n  })\r\n}\r\n"]},"metadata":{},"sourceType":"module"}