{"ast":null,"code":"const moment = require('moment');\n\nconst jsonfile = require('jsonfile');\n\nconst sortBy = require('lodash/sortBy');\n\nexport default (async (req, res) => {\n  let {\n    date = 0,\n    count = 0,\n    type = 1\n  } = req.query,\n      monthData; //默认列表 type1为列表\n\n  if (!date) return res.json({\n    data: []\n  });\n  const {\n    cacheMaxList\n  } = global; //最多存储最近一年的\n  //  28\n\n  /*if(Number(date)){\r\n      console.log(date)\r\n      date=String(date).slice(0,6)\r\n      monthData=imgArr.filter(i=>String(i.date).includes(date))\r\n      //今天距离月初的天数\r\n      // count=new Date(date.slice(4), date.slice(2), 0).getDate()\r\n  }else {\r\n      const now = moment().format('YYYYMM');\r\n      monthData=imgArr.filter(i=>String(i.date).includes(now))\r\n      if(monthData.length<28){\r\n          const last=moment().subtract(1, 'month').format('YYYYMM')\r\n          const lastMonthData=imgArr.filter(i=>String(i.date).includes(last))\r\n          console.log(imgArr.length,'lastMonthData')\r\n          monthData=monthData.concat(lastMonthData)\r\n      }\r\n  }*/\n  //读取后一个月的数据保证始终超过10条\n\n  let currentMonthData = [],\n      lastMonthData = [];\n  const currentFileName = moment(/\\d{6,}/.test(date) ? date : new Date().getTime()).format('YYYYMM');\n  const lastFileName = moment(/\\d{6,}/.test(date) ? date : new Date().getTime()).subtract(1, 'months').format('YYYYMM');\n\n  try {\n    const {\n      imgs: currentMonthImgs\n    } = await jsonfile.readFileSync(`bing_data/${currentFileName}.json`);\n    const {\n      imgs: lastMonthImgs\n    } = await jsonfile.readFileSync(`bing_data/${lastFileName}.json`);\n    currentMonthData = currentMonthImgs;\n    lastMonthData = lastMonthImgs;\n  } catch (e) {}\n\n  const data = [...currentMonthData, ...lastMonthData];\n  let startIndex = data.findIndex(({\n    date: d\n  }) => date === `${d}`);\n  startIndex < 0 && (startIndex = data.length - 1);\n  res.json({\n    data: sortBy(data, 'date').slice(Math.max(0, startIndex - (count - 1)), startIndex + 1).reverse()\n  });\n});","map":null,"metadata":{},"sourceType":"module"}